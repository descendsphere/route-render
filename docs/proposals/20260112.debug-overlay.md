# Proposal: Implement Debug Overlay for Performance Monitoring

**Date:** 2026-01-12
**Author:** Gemini CLI Agent

## 1. Goal

To provide real-time, on-screen diagnostic information (specifically JavaScript heap memory and local storage usage) to assist in debugging potential resource exhaustion issues, particularly on mobile browsers. This overlay should be a permanent, toggleable feature.

## 2. Rationale

The primary motivation stems from reports of the application "quitting" on mobile browsers during tour playback, strongly suggesting resource exhaustion (memory or storage limits). A real-time overlay will provide crucial data to confirm these hypotheses and guide subsequent optimization efforts.

## 3. Guiding Principles & Alignment

This feature aligns with the following project principles:
*   **Observability:** Providing tools for monitoring internal application state.
*   **Debugging Efficiency:** Expediting the diagnosis of critical performance-related bugs.

## 4. Design & Implementation

### 4.1. Key Metrics

The Debug Overlay will display the following metrics:

*   **JS Heap Memory:**
    *   **Source:** `performance.memory` API (non-standard, Chrome-based browsers only).
    *   **Display:** Instantaneous value and a moving average over the last 60 values (representing roughly 1 second at 60 FPS). Format: `JS Heap (MB): 150.5 (Avg: 148.9)`.
    *   **Rationale:** Critical for detecting memory leaks.
*   **LocalStorage Usage:**
    *   **Source:** Calculated by iterating `localStorage` keys and summing string lengths.
    *   **Display:** Instantaneous value in KB. Format: `LocalStorage: 4096.25 KB`.
    *   **Rationale:** Critical for diagnosing storage limit issues which can prevent new GPX files from being loaded/saved.

*Note: FPS will continue to be displayed by CesiumJS's native `scene.debugShowFramesPerSecond = true;`. Primitive count is not included due to lack of stable public API.*

### 4.2. Activation & Visibility

The Debug Overlay will be a permanent feature, controlled by:

*   **UI Toggle:** A checkbox labeled "Show Debug Overlay" in the "Style & Camera" section of the main settings panel.
*   **URL Parameter:** `?debugOverlay=true` (or `false`).

### 4.3. Architecture & Components

1.  **`modules/DebugOverlay.js` (New Module):**
    *   A self-contained class responsible for creating, styling, and updating the overlay's DOM element.
    *   Manages its own internal `MovingAverage` utility for heap memory.
    *   Contains a private `_getLocalStorageUsage()` method to calculate current local storage size.
    *   Will be instantiated once in `app.js`.

2.  **`modules/SettingsManager.js` (Modified):**
    *   Added a new setting: `debugOverlay: { type: 'boolean', defaultValue: false, url: true }`.

3.  **`modules/UIManager.js` (Modified):**
    *   Added a new checkbox in the `init()` method within the "Style & Camera" section.
    *   Wired the checkbox to the `debugOverlay` setting in `SettingsManager`.

4.  **`app.js` (Modified):**
    *   **Orchestration:**
        *   Instantiates `DebugOverlay` after the `viewer` is ready.
        *   Subscribes to the `debugOverlay` setting to call `debugOverlay.show()` or `debugOverlay.hide()`.
        *   **`viewer.scene.postRender` Listener:** Collects fast-changing metrics (JS heap) and pushes them to `debugOverlay.update()` on every frame.
        *   **`setInterval` Timer (2 seconds):** Periodically calculates `localStorage` usage and updates `debugOverlay.update()` with this slower-changing metric.

### 4.4. Code Snippets (Key Logic)

*(These are included in the implementation, but for a formal design document, they would be described conceptually rather than copy-pasted in their entirety.)*

## 5. Trade-offs & Considerations

*   **`performance.memory` Limitations:** JS Heap memory is only available in Chrome-based browsers. The overlay will gracefully handle its absence.
*   **No Cache API Usage:** Browser limitations prevent programmatic query of Cache API storage usage.
*   **Performance Impact:** The overlay itself is designed to have minimal performance impact. Calculation of local storage is throttled to reduce overhead.

## 6. Verification Plan

*   **UI Toggle:** Verify the checkbox in settings correctly shows/hides the overlay.
*   **URL Parameter:** Verify `?debugOverlay=true/false` correctly controls initial visibility.
*   **Metric Updates:** Observe JS Heap (moving average) and LocalStorage (instantaneous) values updating in real-time.
*   **Absence of Regressions:** Confirm no existing functionality is broken.